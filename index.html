<!-- MISSING:
	 * Pagination (Fernando)
     * Loading images (Luis)
     * CSS (Ystallonne)
     * Documentation (sorry, or I code or I comment! =P )
     * And there are more 2 mistakes in the code, Press Ctrl+F and look for the *** to see where are the mistakes! 
     
     Good Luck Guys! =) -->

<html>
	<head>

		<title>My Favourite Things</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.0/jquery.mobile-1.3.0.min.css" />
		<script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
		<script src="http://code.jquery.com/mobile/1.3.0/jquery.mobile-1.3.0.min.js"></script>
	
	</head>

	<body>

		<!-- Main View page - general information -->
		<div data-role="page" id="Main">

			<div data-role="header">
				<h1>Tweets List</h1>
			</div><!-- /header -->

			<div data-role="content">
				<div id="tweets">
					<ul data-role="listview" data-theme="tw">
	
					</ul>
				</div>
			</div><!-- /content -->

			<div data-role="footer">
			</div><!-- /footer -->
		</div><!-- /Main page -->
		<div data-role="page" id="MainPrev">

			<div data-role="header">
				<h1>Tweets List</h1>
			</div><!-- /header -->

			<div data-role="content">
				<div id="tweets">
					<ul data-role="listview" data-theme="tw">
						Prev Page.
					</ul>
				</div>
			</div><!-- /content -->

			<div data-role="footer">
			</div><!-- /footer -->
		</div><!-- /Main page -->
		<div data-role="page" id="MainNext">

			<div data-role="header">
				<h1>Tweets List</h1>
			</div><!-- /header -->

			<div data-role="content">
				<div id="tweets">
					<ul data-role="listview" data-theme="tw">
						Next Page.
					</ul>
				</div>
			</div><!-- /content -->

			<div data-role="footer">
			</div><!-- /footer -->
		</div><!-- /Main page -->

		<!-- User View page -->
		<div data-role="dialog" id="user">

			<div data-role="header">
				<h1>User page</h1>
			</div><!-- /header -->
	
			<div data-role="content">
				<div id="usr">
		
				</div>
			</div><!-- /content -->
	
	
			<div data-role="footer">
				<a href="#Main" data-role="button">Home</a>
			</div><!-- /footer -->
	
		</div><!-- /User Page -->


		<!-- Tweet View page -->
		<div data-role="dialog" id="tweetPage">

			<div data-role="header">
				<h1>Tweet page</h1>
			</div><!-- /header -->

			<div data-role="content">
				<div id="tweet">
		
				</div>
			</div><!-- /content -->
	
			<div data-role="footer">
			<a href="#Main" data-role="button">Home</a>
			</div><!-- /footer -->
	
		</div><!-- /Tweet Page -->


		<!-- Hash Tag Page -->
		<div data-role="page" id="hashTagPage">

			<div data-role="header">
				<h1>Tweets List</h1>
			</div><!-- /header -->

			<div data-role="content">
				<div id="hashTag">
					<ul data-role="listview" data-theme="tw">
	
					</ul>
				</div>
			</div><!-- /content -->

			<div data-role="footer">
				<a href="#Main" data-role="button">Home</a>
			</div><!-- /footer -->
            
		</div><!-- /Hash Tag page -->





		<script type="text/javascript">
			$.getJSON('favs.json', function(data) {
				$.each(data, function (i, value) {
					var text = highlighting(value.text);

					$('#tweets').children('ul').append('<div id='+i+'><a href="javascript:\
					transitionUser('+i+')">' + value.user.name+'</a></br><a href="javascript:\
					transitionTweetPage('+i+')">tweet-page</a></br>'+text+'</br></div>').listview('refresh');
				});
			});
		</script>



		<script type="text/javascript">
			function transitionUser(i) {
				$.getJSON('favs.json', function(data) {
					$('#usr').replaceWith('<div id="usr"><b>'+data[i].user.name+'</b></br>' + 
					data[i].user.description + '</div>').listview('refresh');
				});
				$.mobile.changePage('#user');
			}
		</script>
        
        
        <script type="text/javascript">
            function transitionTweetPage(i) {
                $.getJSON('favs.json', function(data) {
					var text = highlighting(data[i].text);
                    var str = '<div id="tweetDiv"><a href="javascript:\
					transitionUser('+i+')" data-role="button">'+ data[i].user.name+'</a></br>'+text+'</br></div>';	

					var index = findRetweet(data[i].in_reply_to_user_id);
					if(index != -1) {
						str = str + '</br><a href="javascript:transitionUser('+index+')">'+data[index].user.name+'</a>';				
					}					
					$('#tweet').html(str);
                });
                $.mobile.changePage('#tweetPage');
            }
        </script>
        
        
        <script type="text/javascript">
            function findRetweet(status_id) {
				var id = -1;
				if(status_id == null)
					return id;

// json parse does not work because it is a file not a var
//				var look = JSON.parse(favs.json);
//				alert(look.length);
//				for(var i=0; i < look.length; i++) {
//					alert(look[i].id +' -- '+ status_id);
//					if(look[i].id == status_id)
//						return i;
//				}
				
//				$.getJSON('favs.json', function(data) {
//					//Find the tweet id
//					$.each(data, function (i, value) {
//						if(value.id == status_id){
//							id = i;
//							return false;
//						}
//					});
//					alert(id);
//				});
//				alert(id);
				// It does not return the right value ***
				// Problema maldito dos returns! ¬¬'
			}
		</script>


        <script type="text/javascript">
            function findUser(user) {
				var userFound = false;
                $.getJSON('favs.json', function(data) {
					//Find the user index inside the file
					$.each(data, function (i, value) {
						var str = '/'+value.user.name.replace(/\s+/, "").toLowerCase()+'/';
						if(str == user) {
							userFound = true;
							transitionUser(i);
							return false;
						}
					});
					if(userFound == false) {
						alert("Information not available");	
					}
                });

            }
        </script>


        <script type="text/javascript">
            function findHashTag(hash) { 
				$.getJSON('favs.json', function(data) {
					$.each(data, function (i, value) {
						//Find the hash tag in all tweets text
						if(hash.test(value.text)) {
							var text = highlighting(value.text);
							
							$('#hashTag').children('ul').append('<div id='+i+'>' 
								+ value.user.name+'</a></br>'+text+'</br></div>').listview('refresh');
						}
					});
                });
				$('#hashTag').children('ul').empty();
				// Do the transition to the tweet page
                $.mobile.changePage('#hashTagPage');
				
            }
        </script>
        
        
        <script  type="text/javascript">
            function highlighting(text) { 
				text = text.replace(/\s@{1}(\w+)(\s)/g, ' <a href="javascript:findUser(/$1/)">@$1</a>$2');

				text = text.replace(/\s#{1}(\w+)(\s)/g, ' <a href="javascript:\
							findHashTag(/$1/)">#$1</a>$2');			
	
				text = text.replace(/\s(http:\/\/)([a-zA-z0-9.\/]+)/g, ' <a href="$1$2" target="_blank">$1$2</a> ');

				return text;
			}
		</script>

		
		<script type="text/javascript">
		// Set the action for Swipe
			
			// When the page load
			$("#Main").on( "pageinit", function() {
				// Get page id
				var page = "#" + $( this ).attr( "id" );
				// Prefetch the next page
				$.mobile.loadPage( '#user' );
				// Navigate to next page on swipe left
				$("#Main").on( "swipeleft", '#tweets', function() {
					$.mobile.changePage( '#MainNext', { transition: "slide" });
				});
				// Navigate to prev page on swipe right
				$("#Main").on( "swiperight", '#tweets', function() {
					$.mobile.changePage( '#MainPrev', { transition: "slide", reverse: true });
				});
				
				$("#MainNext").on( "swiperight", '#tweets', function() {
					$.mobile.changePage( '#Main', { transition: "slide", reverse: true });
				});
				$("#MainPrev").on( "swipeleft", '#tweets', function() {
					$.mobile.changePage( '#Main', { transition: "slide" });
				});
			
			});
		
		</script>
        
	</body>
</html>
